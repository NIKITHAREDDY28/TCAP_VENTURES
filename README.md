# Bollinger Bands Backtest 

This repository provides a **proof-of-concept** (POC) for running a Bollinger Bands reversal strategy on multiple symbols using [yfinance](https://pypi.org/project/yfinance/) for data fetching and [Streamlit](https://streamlit.io/) for interactive visualization.  
It is configured to use [Poetry](https://python-poetry.org/) for dependency management and virtual environment creation.

## Table of Contents

- [Overview](#overview)  
- [Features](#features)  
- [Directory Structure](#directory-structure)  
- [Installation & Setup (Poetry)](#installation--setup-poetry)  
  - [1. Installing Poetry](#1-installing-poetry)  
  - [2. Installing Dependencies](#2-installing-dependencies)  
- [Usage](#usage)  
  - [1. Backtest Mode](#1-backtest-mode)  
  - [2. Streamlit Mode](#2-streamlit-mode)  
- [Strategy Logic](#strategy-logic)  
- [Frequently Asked Questions](#frequently-asked-questions)  
- [License](#license)

---

## Overview

This project demonstrates:

1. **Data Fetching**: Uses `yfinance` to download OHLCV data for each symbol.  
2. **Column Flattening & Renaming**: Ensures columns such as `Close_AAPL` are renamed to `Close`.  
3. **Bollinger Bands Calculation**: Adds `SMA`, `StdDev`, `UpperBand`, and `LowerBand`.  
4. **Reversal Strategy Execution**: Buys below the lower Bollinger Band and sells above the upper Bollinger Band.  
5. **Result Storage**: Saves trades in `poc_results.csv` and processed data in a `data/{symbol}/data.csv` structure.  
6. **Interactive Visualization**: Displays trades and Bollinger Band charts with buy/sell signals via Streamlit.

---

## Features

- **Robust Column Handling**: Automatically flattens/renames columns so fields (`Open`, `High`, `Low`, `Close`, `Volume`) are recognized.  
- **Adaptable Strategy**: The Bollinger Bands logic is a simple example that can be extended for more complex analyses.  
- **Data Export**: Processed data is saved for each symbol under `data/{symbol}/data.csv`.  
- **Streamlit Integration**: Run `streamlit` to interactively visualize trades and charts.  
- **Poetry for Dependencies**: Makes environment and dependency management simpler, providing a reproducible build.

---

## Directory Structure

```
.
├── pyproject.toml                  # Poetry configuration file
├── poetry.lock                     # Locked dependencies (generated by Poetry)
├── poc_bollinger_backtest.py       # Main script
├── data/                           # Directory for processed data
│   ├── AAPL/
│   │   └── data.csv
│   ├── MSFT/
│   │   └── data.csv
│   ├── BTC-USD/
│   │   └── data.csv
│   └── ETH-USD/
│       └── data.csv
├── poc_results.csv                 # Final trades from backtest
└── README.md                       # This file
```

---

## Installation & Setup (Poetry)

### 1. Installing Poetry

If you haven’t installed Poetry yet:

- Follow the [official instructions](https://python-poetry.org/docs/#installation) or run:

  ```bash
  curl -sSL https://install.python-poetry.org | python3 -
  ```

  Ensure the `poetry` command is in your PATH after installation.

### 2. Installing Dependencies

From the root directory (where `pyproject.toml` is located), run:

```bash
poetry install
```

This will:

1. Create a virtual environment (if not already created).
2. Install all required dependencies (e.g., `yfinance`, `pandas`, `numpy`, `streamlit`, `matplotlib`) as specified in `pyproject.toml`.

Once complete, you can enter the Poetry environment with:

```bash
poetry shell
```

And now you’ll have access to all installed packages within this environment.

---

## Usage

### 1. Backtest Mode

Execute the backtest from your Poetry environment:

```bash
poetry run python poc_bollinger_backtest.py backtest
```

**What Happens?**

- **Data Fetching**: Downloads OHLCV data for each symbol in the `SYMBOLS` list, flattening/renaming columns as necessary.  
- **Bollinger Bands**: Computes `SMA`, `UpperBand`, `LowerBand`, etc.  
- **Reversal Logic**: Buys when `Close < 0.97 * LowerBand`, sells when `Close >= UpperBand`.  
- **Trade Results**: 
  - Saved in `poc_results.csv`.  
  - Processed data for each symbol goes to `data/{symbol}/data.csv`.  

If no trades are generated, you’ll see **“No trades were generated during the backtest.”**

### 2. Streamlit Mode

Launch the Streamlit app within Poetry:

```bash
poetry run streamlit run poc_bollinger_backtest.py
```

**What Happens?**

- The script checks if `poc_results.csv` exists. If not, it automatically runs the backtest.  
- **Trade Results**: A table with all buys/sells.  
- **Symbol Selection**: Choose a symbol to visualize in a drop-down menu.  
- **Charts**: Interactive plots show `Close`, `SMA`, `UpperBand`, `LowerBand`, and buy/sell markers.

---

## Strategy Logic

A simple Bollinger Reversal strategy:

1. **Buy Condition**: `close < 0.97 * lower_band`.  
2. **Sell Condition**: `close >= upper_band`.  
3. **Trade Logging**: Each buy or sell is appended to a list, then combined into a results DataFrame.  
4. **Position Management**: The script checks if we are in a `position` (boolean flag). When a buy triggers, set `position = True`; when a sell triggers, set `position = False`.

> **Note**: This strategy is for demonstration only. In real scenarios, add risk management, capital sizing, or advanced logic.

---

## Frequently Asked Questions

1. **Why do I see “Skipping” messages or no trades generated?**  
   - The script may skip a symbol if essential columns are missing (e.g., `'Open', 'High', 'Low', 'Close', 'Volume'`).  
   - If the date range or strategy parameters yield no signals, no trades will be executed.

2. **Can I add more symbols?**  
   - Yes, modify the `SYMBOLS` list in `poc_bollinger_backtest.py`. For example:
     ```python
     SYMBOLS = [
       "AAPL",
       "MSFT",
       "TSLA",  # add new
       "ETH-USD",
     ]
     ```

3. **Does this strategy account for transaction fees or slippage?**  
   - No, this is a simplified demonstration. You can extend it to handle fees or slippage.

4. **Where do I see processed data?**  
   - After running the backtest, each symbol’s Bollinger Bands data is stored under `data/SYMBOL/data.csv`.

5. **What if I want to run on different date ranges?**  
   - Adjust the `START_DATE` and `END_DATE` variables in the script to your desired timeframe.

---
